version: '3.8'

services:
  astro-deploy:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - .:/app
    environment:
      - AWS_ACCESS_KEY_ID=${WASABI_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${WASABI_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=eu-central-2
      - WASABI_ENDPOINT_URL=${WASABI_ENDPOINT_URL}
      - WASABI_BUCKET_NAME=${WASABI_BUCKET_NAME}
    command: >
      sh -c "
        apk add --no-cache python3 py3-pip bash &&
        python3 -m venv /tmp/venv &&
        . /tmp/venv/bin/activate &&
        pip install --upgrade pip &&
        pip install awscli &&
        npm install &&
        npm run build &&
        aws s3 sync ./dist s3://${WASABI_BUCKET_NAME} --endpoint-url=${WASABI_ENDPOINT_URL} --delete
      "
